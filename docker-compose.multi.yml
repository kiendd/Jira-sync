version: "3.9"

# Docker Compose Multi-Instance Configuration
# ==========================================
# File này cho phép chạy nhiều Jira Sync instances độc lập.
# Mỗi instance có MongoDB riêng và config riêng.
#
# Cách sử dụng:
#   1. Copy .env.multi.example thành .env.multi và cấu hình
#   2. Copy config/sync-rules.example.json thành config/sync-ab.json và config/sync-cd.json
#   3. Chỉnh sửa các config files theo nhu cầu
#   4. Chạy: docker-compose -f docker-compose.multi.yml up -d
#
# Thêm instance mới:
#   1. Thêm service block (copy từ instance hiện có)
#   2. Thêm biến vào .env.multi
#   3. Tạo config file mới trong config/

services:
  # ========================================
  # Instance 1: Project A <-> Project B
  # ========================================
  sync-ab:
    image: jira-sync:latest
    container_name: jira-sync-ab
    restart: unless-stopped
    environment:
      INSTANCE_NAME: project-ab
      # Jira authentication
      JIRA_AUTH_TYPE: ${JIRA_AUTH_TYPE:-pat}
      JIRA_BASE_URL: ${JIRA_BASE_URL_AB}
      JIRA_EMAIL: ${JIRA_EMAIL_AB:-}
      JIRA_API_TOKEN: ${JIRA_API_TOKEN_AB}
      # Project configuration
      USER_PROJECT_KEY: ${USER_PROJECT_KEY_A:-USER-A}
      DEV_PROJECT_KEY: ${DEV_PROJECT_KEY_A:-DEV-A}
      # Sync settings
      SYNC_INTERVAL_MINUTES: ${SYNC_INTERVAL_MINUTES:-5}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      # Database (sử dụng MongoDB riêng cho instance này)
      DATABASE_URL: mongodb://mongo-ab:27017
      DATABASE_NAME: ${DATABASE_NAME_A:-sync_ab}
    depends_on:
      - mongo-ab
    volumes:
      # Mount config file riêng cho instance này
      # File này phải được tạo từ config/sync-rules.example.json
      - ./config/sync-ab.json:/app/config/sync-rules.json:ro
    networks:
      default:
        aliases:
          - sync-ab
    # Health check để giám sát trạng thái
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  # MongoDB cho Instance AB
  mongo-ab:
    image: mongo:7
    container_name: mongo-ab
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: ${DATABASE_NAME_A:-sync_ab}
    volumes:
      - mongo-ab-data:/data/db
    networks:
      default:
        aliases:
          - mongo-ab
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================
  # Instance 2: Project C <-> Project D
  # ========================================
  # Instance này hoàn toàn độc lập với Instance 1
  # Có thể sync giữa các cặp project khác nhau
  sync-cd:
    image: jira-sync:latest
    container_name: jira-sync-cd
    restart: unless-stopped
    environment:
      INSTANCE_NAME: project-cd
      # Jira authentication (riêng cho instance này)
      JIRA_AUTH_TYPE: ${JIRA_AUTH_TYPE:-pat}
      JIRA_BASE_URL: ${JIRA_BASE_URL_CD}
      JIRA_EMAIL: ${JIRA_EMAIL_CD:-}
      JIRA_API_TOKEN: ${JIRA_API_TOKEN_CD}
      # Project configuration (cặp project khác)
      USER_PROJECT_KEY: ${USER_PROJECT_KEY_C:-USER-C}
      DEV_PROJECT_KEY: ${DEV_PROJECT_KEY_C:-DEV-C}
      # Sync settings
      SYNC_INTERVAL_MINUTES: ${SYNC_INTERVAL_MINUTES:-5}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      # Database (MongoDB riêng)
      DATABASE_URL: mongodb://mongo-cd:27017
      DATABASE_NAME: ${DATABASE_NAME_C:-sync_cd}
    depends_on:
      - mongo-cd
    volumes:
      - ./config/sync-cd.json:/app/config/sync-rules.json:ro
    networks:
      default:
        aliases:
          - sync-cd
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  # MongoDB cho Instance CD
  mongo-cd:
    image: mongo:7
    container_name: mongo-cd
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: ${DATABASE_NAME_C:-sync_cd}
    volumes:
      - mongo-cd-data:/data/db
    networks:
      default:
        aliases:
          - mongo-cd
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

# ========================================
# Network Configuration
# ========================================
# Sử dụng network riêng để các instances có thể giao tiếp với MongoDB
# nhưng vẫn được cách ly với các services khác
networks:
  default:
    name: jira-sync-multi
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ========================================
# Volumes
# ========================================
# Mỗi instance có volume MongoDB riêng để đảm bảo cách ly dữ liệu
volumes:
  mongo-ab-data:
    name: jira-sync-multi-mongo-ab
  mongo-cd-data:
    name: jira-sync-multi-mongo-cd

# ========================================
# Hướng dẫn thêm Instance mới
# ========================================
# Để thêm instance mới (ví dụ: sync-xy cho USER-X ↔ DEV-Y):
#
# 1. Thêm service block sau:
#    sync-xy:
#      image: jira-sync:latest
#      container_name: jira-sync-xy
#      ... (các config tương tự như trên)
#      environment:
#        INSTANCE_NAME: project-xy
#        DATABASE_URL: mongodb://mongo-xy:27017
#        DATABASE_NAME: ${DATABASE_NAME_XY:-sync_xy}
#      volumes:
#        - ./config/sync-xy.json:/app/config/sync-rules.json:ro
#
# 2. Thêm MongoDB cho instance mới:
#    mongo-xy:
#      image: mongo:7
#      container_name: mongo-xy
#      volumes:
#        - mongo-xy-data:/data/db
#
# 3. Thêm volume:
#    mongo-xy-data:
#      name: jira-sync-multi-mongo-xy
#
# 4. Thêm biến vào .env.multi:
#    JIRA_BASE_URL_XY=https://...
#    JIRA_API_TOKEN_XY=...
#    USER_PROJECT_KEY_XY=USER-X
#    DEV_PROJECT_KEY_XY=DEV-Y
#    DATABASE_NAME_XY=sync_xy
#
# 5. Tạo config file:
#    cp config/sync-rules.example.json config/sync-xy.json
