version: "3.9"

# Docker Compose Consolidated Configuration
# ==========================================
# File này chạy nhiều sync pairs trong 1 container sử dụng child processes.
# Tiết kiệm tài nguyên: 1 container thay vì N containers, 1 MongoDB thay vì N MongoDB.
#
# Cấu hình JIRA được đọc từ file JSON trong thư mục config/
# Mỗi worker có thể kết nối đến JIRA instance khác nhau
#
# Cách sử dụng:
#   1. Tạo config files trong config/ (sync-ab.json, sync-cd.json, ...)
#   2. Mỗi file chứa JIRA credentials cho một worker
#   3. Build và chạy: docker-compose up -d
#
# Thêm sync pair mới:
#   1. Tạo file config mới (ví dụ: config/sync-xy.json)
#   2. Restart container

services:
  # ========================================
  # Jira Sync Service (Single Container)
  # ========================================
  jira-sync:
    build: .
    image: jira-sync:latest
    container_name: jira-sync-consolidated
    restart: unless-stopped
    environment:
      # Database (shared MongoDB instance)
      DATABASE_URL: mongodb://mongo:27017
      # Sync settings
      SYNC_INTERVAL_MINUTES: ${SYNC_INTERVAL_MINUTES:-5}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      # Health check server
      PORT: ${PORT:-3000}
      # Config directory (mount JSON config files here)
      CONFIG_DIR: /app/config
    depends_on:
      - mongo
    volumes:
      # Mount tất cả config files - mỗi file = 1 worker
      - ./config:/app/config:ro
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
    networks:
      default:
        aliases:
          - jira-sync
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  # ========================================
  # MongoDB (Single Instance, Multiple Databases)
  # ========================================
  mongo:
    image: mongo:7
    container_name: mongo-consolidated
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: ${MONGO_INITDB_DATABASE:-jira_sync}
    volumes:
      - mongo-data:/data/db
    networks:
      default:
        aliases:
          - mongo
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 10s
      timeout: 5s
      retries: 5

# ========================================
# Network Configuration
# ========================================
networks:
  default:
    name: jira-sync-consolidated
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16

# ========================================
# Volumes
# ========================================
volumes:
  mongo-data:
    name: jira-sync-consolidated-mongo

# ========================================
# Hướng dẫn cấu hình
# ========================================
# 1. Tạo config files trong config/:
#    cp config/sync-rules.example.json config/sync-ab.json
#    cp config/sync-rules.example.json config/sync-cd.json
#
# 2. Chỉnh sửa mỗi config file:
#    - Đặt jira.baseUrl, jira.email, jira.apiToken
#    - Đặt userProjectKey và devProjectKey
#    - Đặt tên config phù hợp (name field)
#
# 3. Mỗi worker sẽ tự động được spawn cho mỗi file config
#
# 4. Build và chạy:
#    docker-compose build
#    docker-compose up -d
#
# 5. Kiểm tra health:
#    curl http://localhost:3000/health
#
# 6. Xem logs:
#    docker logs -f jira-sync-consolidated
